---
- name: Set up shell environment for kubectl
  hosts: rancher
  gather_facts: false
  become: true
  vars_files:
    - vars/kubernetes.yml
  tasks:
    - name: Make K3s kubeconfig readable
      vars:
        file_desc: "K3s kubeconfig"
        file_path: "{{ k3s_kubeconfig }}"
      # https://docs.ansible.com/ansible/latest/collections/ansible/builtin/include_tasks_module.html
      ansible.builtin.include_tasks: tasks/readable.yml

- name: Set up admin user's home directory
  hosts: all
  vars_files:
    - vars/files.yml
  tasks:
    - name: Allow sudo commands without password
      # https://docs.ansible.com/ansible/latest/collections/ansible/builtin/template_module.html
      ansible.builtin.template:
        src: templates/nopasswd.j2
        dest: /etc/sudoers.d/nopasswd
        mode: "0440"
      become: true

    - name: Copy dot files into home directory
      # https://docs.ansible.com/ansible/latest/collections/ansible/builtin/copy_module.html
      ansible.builtin.copy:
        src: "{{ playbook_dir | dirname }}/{{ item }}"
        dest: "{{ ansible_user_dir }}/{{ item }}"
        mode: "0644"
        directory_mode: "0755"
      loop: "{{ copy_files }}"
      notify: Touch copied files
  handlers:
    - name: Touch copied files
      # https://docs.ansible.com/ansible/latest/collections/ansible/builtin/shell_module.html
      ansible.builtin.shell: |-
        # restart Bash and load copied .bash_aliases
        # in order to use my custom touch functions
        exec /bin/bash -c '
          . .bash_aliases
          _touch -t 00 . .sudo_as_admin_successful
          # zeros out MM:ss file times recursively
          touchall -t 00 {{ copy_files | join(' ') }}'
      changed_when: true
